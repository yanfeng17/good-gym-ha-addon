# Good-GYM Addon æŠ€æœ¯æ–‡æ¡£

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RTSP Camera    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Video Stream
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Good-GYM Addon Container          â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ RTSP Handler â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚ Frames                   â”‚
â”‚         â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ RTMPose Processorâ”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚ Keypoints                â”‚
â”‚         â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Exercise Counter â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚ Count/Stage              â”‚
â”‚         â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ MQTT Publisher   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ MQTT Messages
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MQTT Broker           â”‚
â”‚   (Mosquitto)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Home Assistant         â”‚
â”‚  - Sensors              â”‚
â”‚  - Automations          â”‚
â”‚  - Dashboard            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

1. **è§†é¢‘é‡‡é›†**: RTSP Handler è¿æ¥æ‘„åƒå¤´è·å–è§†é¢‘æµ
2. **å§¿æ€æ£€æµ‹**: RTMPose Processor åˆ†ææ¯å¸§æå–äººä½“å…³é”®ç‚¹
3. **è¿åŠ¨è®¡æ•°**: Exercise Counter æ ¹æ®å…³é”®ç‚¹è§’åº¦è®¡ç®—è¿åŠ¨æ¬¡æ•°
4. **æ•°æ®å‘å¸ƒ**: MQTT Publisher å°†è®¡æ•°æ¨é€åˆ° Home Assistant
5. **ç”¨æˆ·äº¤äº’**: é€šè¿‡ HA ä»ªè¡¨æ¿æŸ¥çœ‹æ•°æ®ï¼Œè§¦å‘è‡ªåŠ¨åŒ–

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. ConfigManager (`config_manager.py`)

**åŠŸèƒ½**: ç®¡ç† addon é…ç½®

**é…ç½®åŠ è½½é¡ºåº**:
1. Home Assistant options.json (`/data/options.json`)
2. ç¯å¢ƒå˜é‡ (fallback for development)

**å…³é”®æ–¹æ³•**:
- `_load_config()`: åŠ è½½é…ç½®
- `_validate_config()`: éªŒè¯å¿…è¦å‚æ•°
- `get_mqtt_config()`: è·å– MQTT é…ç½®
- `get_rtsp_config()`: è·å– RTSP é…ç½®
- `get_detection_config()`: è·å–æ£€æµ‹é…ç½®

### 2. RTSPHandler (`rtsp_handler.py`)

**åŠŸèƒ½**: ç®¡ç† RTSP è§†é¢‘æµè¿æ¥

**ç‰¹æ€§**:
- è‡ªåŠ¨é‡è¿æœºåˆ¶
- çº¿ç¨‹åŒ–å¸§æ•è·
- å¸§ç¼“å†²ç®¡ç†
- é”™è¯¯è®¡æ•°å’Œæ¢å¤

**å…³é”®æ–¹æ³•**:
- `connect()`: è¿æ¥ RTSP æµ
- `start_capture()`: å¯åŠ¨æ•è·çº¿ç¨‹
- `_capture_loop()`: ä¸»æ•è·å¾ªç¯
- `get_latest_frame()`: è·å–æœ€æ–°å¸§ (çº¿ç¨‹å®‰å…¨)

**ä¼˜åŒ–ç­–ç•¥**:
```python
# æœ€å°åŒ–å»¶è¿Ÿ
self.cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)

# ç›®æ ‡å¸§ç‡
self.cap.set(cv2.CAP_PROP_FPS, 30)
```

### 3. RTMPoseProcessor (`core/rtmpose_processor.py`)

**åŠŸèƒ½**: RTMPose å§¿æ€æ£€æµ‹

**æ¨¡å‹æ¨¡å¼**:
- `performance`: å¿«é€Ÿä½†ç²¾åº¦è¾ƒä½
- `balanced`: å¹³è¡¡é€Ÿåº¦å’Œç²¾åº¦ (é»˜è®¤)
- `accuracy`: é«˜ç²¾åº¦ä½†è¾ƒæ…¢

**å¤„ç†æµç¨‹**:
```python
frame -> RTMPose Inference -> Keypoints -> Angle Calculation -> Count Update
```

**å…³é”®ç‚¹æ ¼å¼ (COCO 17)**:
```
0: nose, 1: left_eye, 2: right_eye
3: left_ear, 4: right_ear
5: left_shoulder, 6: right_shoulder
7: left_elbow, 8: right_elbow
9: left_wrist, 10: right_wrist
11: left_hip, 12: right_hip
13: left_knee, 14: right_knee
15: left_ankle, 16: right_ankle
```

### 4. ExerciseCounter (`exercise_counters.py`)

**åŠŸèƒ½**: è¿åŠ¨è®¡æ•°é€»è¾‘

**å…³é”®ç‰¹æ€§**:
- è§’åº¦å¹³æ»‘ (æ»‘åŠ¨çª—å£)
- çŠ¶æ€æœº (up/down)
- æ—¶é—´é™åˆ¶ (é˜²æ­¢è¿‡å¿«è®¡æ•°)
- åŒä¾§ç‹¬ç«‹è®¡æ•° (è…¿éƒ¨è¿åŠ¨)

**è§’åº¦è®¡ç®—**:
```python
# ä¸‰ç‚¹è§’åº¦è®¡ç®—
def calculate_angle(a, b, c):
    """
    è®¡ç®—ä¸‰ç‚¹ä¹‹é—´çš„è§’åº¦
    a: ç¬¬ä¸€ä¸ªç‚¹
    b: ä¸­é—´ç‚¹ (é¡¶ç‚¹)
    c: ç¬¬ä¸‰ä¸ªç‚¹
    """
    ba = a - b
    bc = c - b
    cosine_angle = dot(ba, bc) / (norm(ba) * norm(bc))
    angle = arccos(cosine_angle)
    return degrees(angle)
```

**çŠ¶æ€æœº**:
```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Start  â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”Œâ”€â–¶â”‚   Up    â”‚â—€â”€â”
  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚
  â”‚       â”‚       â”‚
  â”‚ angle â”‚angle  â”‚
  â”‚  < T1 â”‚ > T2  â”‚
  â”‚       â–¼       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â””â”€â”€â”‚  Down   â”‚â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     (count++)
```

### 5. MQTTPublisher (`mqtt_publisher.py`)

**åŠŸèƒ½**: MQTT æ¶ˆæ¯å‘å¸ƒ

**MQTT Discovery**:
```json
{
  "name": "Good-GYM Squat Counter",
  "state_topic": "homeassistant/sensor/good_gym_squat/state",
  "value_template": "{{ value_json.count }}",
  "unit_of_measurement": "reps",
  "device": {
    "identifiers": ["good_gym_addon"],
    "name": "Good-GYM Exercise Tracker",
    "model": "RTMPose AI v2.0"
  }
}
```

**çŠ¶æ€æ¶ˆæ¯**:
```json
{
  "count": 15,
  "stage": "down",
  "angle": 125.5,
  "exercise_type": "squat",
  "timestamp": "2025-12-24T14:35:00Z",
  "session_start": "2025-12-24T14:30:00Z",
  "frame_count": 450
}
```

### 6. GoodGymService (`main.py`)

**åŠŸèƒ½**: ä¸»æœåŠ¡åè°ƒå™¨

**åˆå§‹åŒ–æµç¨‹**:
1. åŠ è½½é…ç½®
2. åˆå§‹åŒ– ExerciseCounter
3. åˆå§‹åŒ– RTMPoseProcessor
4. è¿æ¥ MQTT broker
5. å¯åŠ¨ RTSP æ•è·

**ä¸»å¾ªç¯**:
```python
while is_running:
    # RTSP handler åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ•è·å¸§
    # æ¯å¸§è§¦å‘ process_frame() å›è°ƒ
    
    process_frame():
        1. è·³å¸§å¤„ç† (å¯é€‰)
        2. RTMPose å§¿æ€æ£€æµ‹
        3. è¿åŠ¨è®¡æ•°
        4. MQTT å‘å¸ƒ (æŒ‰é—´éš”æˆ–è®¡æ•°å˜åŒ–)
```

## æ€§èƒ½ä¼˜åŒ–

### CPU ä½¿ç”¨ä¼˜åŒ–

1. **è·³å¸§å¤„ç†**:
   ```yaml
   frame_skip: 2  # å¤„ç†æ¯ç¬¬2å¸§
   ```

2. **é™ä½æ¨ç†é¢‘ç‡**:
   ```yaml
   detection_interval: 0.2  # æ¯0.2ç§’æ£€æµ‹ä¸€æ¬¡
   ```

3. **é€‰æ‹©å¿«é€Ÿæ¨¡å¼**:
   ```yaml
   rtmpose_mode: "performance"
   ```

4. **é™ä½åˆ†è¾¨ç‡**: åœ¨æ‘„åƒå¤´ç«¯è®¾ç½®è¾ƒä½åˆ†è¾¨ç‡

### å†…å­˜ä¼˜åŒ–

- ä½¿ç”¨å¸§ç¼“å†²åŒºå¤§å°ä¸º 1
- åŠæ—¶é‡Šæ”¾å¤„ç†åçš„å¸§
- é¿å…å­˜å‚¨å†å²æ•°æ® (ç”± HA å¤„ç†)

### ç½‘ç»œä¼˜åŒ–

- RTSP: ä½¿ç”¨æœ¬åœ°ç½‘ç»œï¼Œé¿å…äº’è”ç½‘
- MQTT: QoS 0 ç”¨äºé«˜é¢‘çŠ¶æ€æ¶ˆæ¯
- MQTT: QoS 1 ç”¨äºé…ç½®å’ŒçŠ¶æ€æ¶ˆæ¯

## è‡ªå®šä¹‰è¿åŠ¨é…ç½®

### è¿åŠ¨é…ç½®æ–‡ä»¶ (`data/exercises.json`)

```json
{
  "exercises": {
    "my_exercise": {
      "name_zh": "æˆ‘çš„è¿åŠ¨",
      "name_en": "My Exercise",
      "down_angle": 120,
      "up_angle": 170,
      "keypoints": {
        "left": [5, 7, 9],
        "right": [6, 8, 10]
      },
      "is_leg_exercise": false,
      "angle_point": [6, 8, 10]
    }
  }
}
```

### å‚æ•°è¯´æ˜

- `down_angle`: ä¸‹é™çŠ¶æ€çš„è§’åº¦é˜ˆå€¼
- `up_angle`: ä¸Šå‡çŠ¶æ€çš„è§’åº¦é˜ˆå€¼
- `keypoints.left`: å·¦ä¾§ä¸‰ä¸ªå…³é”®ç‚¹ç´¢å¼•
- `keypoints.right`: å³ä¾§ä¸‰ä¸ªå…³é”®ç‚¹ç´¢å¼•
- `is_leg_exercise`: æ˜¯å¦ä¸ºè…¿éƒ¨è¿åŠ¨ (å½±å“è®¡æ•°é€»è¾‘)
- `angle_point`: ç”¨äºæ˜¾ç¤ºçš„è§’åº¦ç‚¹

### æ·»åŠ åˆ° config.yaml

```yaml
schema:
  exercise_type: list(squat|pushup|...|my_exercise)
```

## Docker æ„å»º

### å¤šæ¶æ„æ”¯æŒ

```bash
# AMD64
docker build --platform linux/amd64 -t good-gym-addon-amd64 .

# ARM64 (æ ‘è“æ´¾ 4)
docker build --platform linux/arm64 -t good-gym-addon-aarch64 .
```

### æœ¬åœ°æµ‹è¯•

```bash
# æ„å»ºé•œåƒ
docker build -f homeassistant/Dockerfile -t good-gym-test .

# è¿è¡Œå®¹å™¨
docker run --rm \
  -e RTSP_URL="rtsp://192.168.1.100:554/stream" \
  -e MQTT_HOST="192.168.1.50" \
  -e MQTT_PORT="1883" \
  -e EXERCISE_TYPE="squat" \
  good-gym-test
```

## å®‰å…¨è€ƒè™‘

1. **MQTT è®¤è¯**: å§‹ç»ˆä½¿ç”¨ç”¨æˆ·å/å¯†ç 
2. **RTSP è®¤è¯**: æ‘„åƒå¤´åº”è®¾ç½®å¯†ç 
3. **ç½‘ç»œéš”ç¦»**: å»ºè®®åœ¨æœ¬åœ°ç½‘ç»œè¿è¡Œ
4. **æ•°æ®éšç§**: è§†é¢‘æµä¸å­˜å‚¨,ä¸ä¸Šä¼ 

## æ—¥å¿—å’Œè°ƒè¯•

### å¯ç”¨è°ƒè¯•æ¨¡å¼

```yaml
enable_debug: true
```

### æŸ¥çœ‹æ—¥å¿—

Home Assistant:
```
Supervisor > Good-GYM > Logs
```

Docker:
```bash
docker logs <container_id>
```

### å¸¸è§æ—¥å¿—ä¿¡æ¯

- `âœ“`: æˆåŠŸæ“ä½œ
- `âš `: è­¦å‘Š
- `âœ—`: é”™è¯¯
- `ğŸ“¸`: å¸§å¤„ç†
- `ğŸ“¡`: MQTT é€šä¿¡
- `ğŸ¥`: RTSP è¿æ¥

## API æ‰©å±• (æœªæ¥)

### REST API (å¯é€‰)

å¯ä»¥æ·»åŠ ç®€å•çš„ HTTP API:

```python
# è·å–å½“å‰çŠ¶æ€
GET /api/status
{
  "count": 15,
  "stage": "down",
  "is_connected": true
}

# é‡ç½®è®¡æ•°
POST /api/reset

# åˆ‡æ¢è¿åŠ¨ç±»å‹
POST /api/exercise
{
  "type": "pushup"
}
```

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®! è¯·éµå¾ª:

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»º Pull Request

## å¸¸è§é—®é¢˜ FAQ

**Q: æ”¯æŒå¤šä¸ªæ‘„åƒå¤´å—?**
A: å½“å‰ç‰ˆæœ¬æ¯ä¸ª addon å®ä¾‹æ”¯æŒä¸€ä¸ªæ‘„åƒå¤´ã€‚å¯ä»¥å®‰è£…å¤šä¸ª addon å®ä¾‹ã€‚

**Q: å¯ä»¥ç¦»çº¿ä½¿ç”¨å—?**
A: å¯ä»¥,æ‰€æœ‰å¤„ç†éƒ½åœ¨æœ¬åœ°å®Œæˆã€‚

**Q: éœ€è¦ GPU å—?**
A: ä¸éœ€è¦,RTMPose å¯ä»¥åœ¨ CPU ä¸Šè¿è¡Œã€‚

**Q: å»¶è¿Ÿæœ‰å¤šå°‘?**
A: é€šå¸¸ < 100ms,å–å†³äºç½‘ç»œå’Œç¡¬ä»¶ã€‚

**Q: æ”¯æŒå½•åƒå—?**
A: å½“å‰ä¸æ”¯æŒã€‚å¯ä»¥ä½¿ç”¨ HA çš„å½•åƒåŠŸèƒ½ã€‚

## ç‰ˆæœ¬å†å²

- **v2.0.0**: Home Assistant Addon é¦–æ¬¡å‘å¸ƒ
- **v1.2.0**: åŸæ¡Œé¢åº”ç”¨æœ€åç‰ˆæœ¬
